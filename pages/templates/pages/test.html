{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حجز الغرفة | Grand Royal</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <style>
        .booking-step { display: none; }
        .booking-step.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
        }
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: #6c757d;
            transition: all 0.3s;
        }
        .step-item.active { color: #d4af37; }
        .step-item.completed { color: #28a745; }
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: all 0.3s;
        }
        .step-item.active .step-number { background: #d4af37; color: #1a1a2e; }
        .step-item.completed .step-number { background: #28a745; color: white; }
        
        .room-preview {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }
        .room-preview img {
            width: 150px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .payment-method {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .payment-method:hover, .payment-method.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.05);
        }
        .payment-method input {
            position: absolute;
            opacity: 0;
        }
        .payment-method i {
            font-size: 32px;
            margin-bottom: 10px;
            color: #1a1a2e;
            display: block;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: #d4af37;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .booking-summary {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 100px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .summary-item.total {
            border-top: 2px solid #d4af37;
            border-bottom: none;
            margin-top: 10px;
            padding-top: 20px;
            font-size: 20px;
            font-weight: 700;
        }
        
        .btn {
            padding: 12px 30px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .btn-gold {
            background: linear-gradient(45deg, #d4af37, #f4d03f);
            color: #1a1a2e;
        }
        .btn-outline {
            background: transparent;
            border: 2px solid #d4af37;
            color: #d4af37;
        }
        .btn-block { width: 100%; }
        .btn-lg { padding: 15px 40px; font-size: 18px; }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a1a2e;
        }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .payment-methods { grid-template-columns: 1fr; }
            .step-indicator { gap: 15px; font-size: 14px; }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar scrolled">
        <div class="nav-container">
            <a href="{% url 'home' %}" class="logo">
                <div class="logo-icon"><i class="fas fa-crown"></i></div>
                <span class="logo-text">Grand <span>Royal</span></span>
            </a>
            <ul class="nav-links">
                <li><a href="{% url 'home' %}">الرئيسية</a></li>
                <li><a href="{% url 'pages:room_list' %}">الغرف</a></li>
                <li><a href="{% url 'services' %}">الخدمات</a></li>
            </ul>
        </div>
    </nav>

    <section class="booking-section" style="padding: 120px 0 60px;">
        <div class="container">
            <div class="section-header">
                <span class="section-subtitle">إتمام الحجز</span>
                <h2 class="section-title">احجز إقامتك الفاخرة</h2>
            </div>

            <!-- مؤشر الخطوات -->
            <div class="step-indicator">
                <div class="step-item active" id="step1-indicator">
                    <div class="step-number">1</div>
                    <span>بيانات الحجز</span>
                </div>
                <div class="step-item" id="step2-indicator">
                    <div class="step-number">2</div>
                    <span>بيانات النزيل</span>
                </div>
                <div class="step-item" id="step3-indicator">
                    <div class="step-number">3</div>
                    <span>الدفع</span>
                </div>
            </div>

            <!-- رسائل Django -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}" style="margin-bottom: 20px; padding: 15px; border-radius: 10px; text-align: center; background: {% if message.tags == 'success' %}#d4edda{% else %}#f8d7da{% endif %};">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- النموذج الرئيسي -->
            <form method="post" action="" id="bookingForm" novalidate>
                {% csrf_token %}
                
                <div class="booking-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                    
                    <!-- الخطوات -->
                    <div class="booking-form-card" style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 5px 30px rgba(0,0,0,0.1);">
                        
                        <!-- الخطوة 1: تفاصيل الحجز -->
                        <div class="booking-step active" id="step1">
                            <h3 style="margin-bottom: 25px; color: #1a1a2e;">تفاصيل الحجز</h3>
                            
                            <div class="room-preview">
                                <img src="{{ room.image.url }}" alt="{{ room.name }}">
                                <div>
                                    <h4>{{ room.name }}</h4>
                                    <p style="color: #d4af37; font-size: 20px; font-weight: 700;">
                                        {{ room.price }}$ / ليلة
                                    </p>
                                    <small style="color: #6c757d;">{{ room.get_flag_display }}</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>تاريخ الوصول *</label>
                                    {{ form.arrival_date }}
                                    {% if form.arrival_date.errors %}
                                        <div class="error-message">{{ form.arrival_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label>تاريخ المغادرة *</label>
                                    {{ form.departure_date }}
                                    {% if form.departure_date.errors %}
                                        <div class="error-message">{{ form.departure_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>عدد البالغين *</label>
                                    {{ form.number_of_adults }}
                                </div>
                                <div class="form-group">
                                    <label>عدد الأطفال</label>
                                    {{ form.number_of_children }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label>طلبات خاصة (اختياري)</label>
                                {{ form.special_requests }}
                            </div>

                            <button type="button" class="btn btn-gold btn-block btn-lg" onclick="nextStep(2)">
                                التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <!-- الخطوة 2: بيانات النزيل -->
                        <div class="booking-step" id="step2">
                            <h3 style="margin-bottom: 25px; color: #1a1a2e;">بيانات النزيل</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>الاسم الأول *</label>
                                    {{ form.first_name }}
                                    {% if form.first_name.errors %}
                                        <div class="error-message">{{ form.first_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label>الاسم الأخير *</label>
                                    {{ form.last_name }}
                                    {% if form.last_name.errors %}
                                        <div class="error-message">{{ form.last_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="form-group">
                                <label>البريد الإلكتروني *</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="error-message">{{ form.email.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label>رقم الهاتف *</label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                    <div class="error-message">{{ form.phone.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label>الجنسية</label>
                                {{ form.nationality }}
                            </div>

                            <div style="display: flex; gap: 15px;">
                                <button type="button" class="btn btn-outline" style="flex: 1;" onclick="prevStep(1)">
                                    <i class="fas fa-arrow-right"></i> السابق
                                </button>
                                <button type="button" class="btn btn-gold btn-lg" style="flex: 2;" onclick="nextStep(3)">
                                    التالي <i class="fas fa-arrow-left"></i>
                                </button>
                            </div>
                        </div>

                        <!-- الخطوة 3: الدفع -->
                        <div class="booking-step" id="step3">
                            <h3 style="margin-bottom: 25px; color: #1a1a2e;">طريقة الدفع</h3>
                            
                            <div class="payment-methods">
                                <label class="payment-method selected" onclick="selectPayment(this, 'cash')">
                                    <input type="radio" name="payment_method" value="cash" checked>
                                    <i class="fas fa-money-bill-wave"></i>
                                    <div>كاش</div>
                                </label>
                                <label class="payment-method" onclick="selectPayment(this, 'credit_card')">
                                    <input type="radio" name="payment_method" value="credit_card">
                                    <i class="fas fa-credit-card"></i>
                                    <div>بطاقة ائتمان</div>
                                </label>
                                <label class="payment-method" onclick="selectPayment(this, 'bank_transfer')">
                                    <input type="radio" name="payment_method" value="bank_transfer">
                                    <i class="fas fa-university"></i>
                                    <div>تحويل بنكي</div>
                                </label>
                            </div>

                            <!-- تفاصيل البطاقة (تظهر فقط عند اختيار بطاقة) -->
                            <div id="cardDetails" style="display: none; margin-top: 20px;">
                                <div class="form-group">
                                    <label>رقم البطاقة</label>
                                    <input type="text" class="form-control" placeholder="0000 0000 0000 0000" maxlength="19">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>تاريخ الانتهاء</label>
                                        <input type="text" class="form-control" placeholder="MM/YY" maxlength="5">
                                    </div>
                                    <div class="form-group">
                                        <label>CVV</label>
                                        <input type="text" class="form-control" placeholder="123" maxlength="3">
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button type="button" class="btn btn-outline" style="flex: 1;" onclick="prevStep(2)">
                                    <i class="fas fa-arrow-right"></i> السابق
                                </button>
                                <button type="submit" class="btn btn-gold btn-lg" style="flex: 2;">
                                    تأكيد الحجز <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>

                    </div>

                    <!-- ملخص الحجز -->
                    <div class="booking-summary">
                        <h3 style="margin-bottom: 20px; color: #1a1a2e;">ملخص الحجز</h3>
                        
                        <div class="summary-item">
                            <span>الغرفة</span>
                            <strong>{{ room.name }}</strong>
                        </div>
                        <div class="summary-item">
                            <span>السعر / ليلة</span>
                            <strong>{{ room.price }}$</strong>
                        </div>
                        <div class="summary-item">
                            <span>عدد الليالي</span>
                            <strong id="summaryNights">-</strong>
                        </div>
                        <div class="summary-item">
                            <span>الضيوف</span>
                            <strong id="summaryGuests">-</strong>
                        </div>
                        <div class="summary-item total">
                            <span>الإجمالي</span>
                            <strong id="summaryTotal" style="color: #d4af37;">-</strong>
                        </div>
                    </div>

                </div>
            </form>
        </div>
    </section>

    <script>
        let currentStep = 1;
        const roomPrice = {{ room.price }};

        // تحديث الملخص
        function updateSummary() {
            const checkIn = document.getElementById('checkInDate').value;
            const checkOut = document.getElementById('checkOutDate').value;
            const adults = document.getElementById('adultsCount').value;
            const children = document.getElementById('childrenCount').value;

            if (checkIn && checkOut) {
                const start = new Date(checkIn);
                const end = new Date(checkOut);
                const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                
                if (nights > 0) {
                    const total = nights * roomPrice;
                    document.getElementById('summaryNights').textContent = nights + ' ليالي';
                    document.getElementById('summaryGuests').textContent = `${adults} بالغين, ${children} أطفال`;
                    document.getElementById('summaryTotal').textContent = total + '$';
                }
            }
        }

        // مستمعي الأحداث
        document.getElementById('checkInDate')?.addEventListener('change', function() {
            // تعيين الحد الأدنى للمغادرة
            const checkIn = new Date(this.value);
            const minCheckOut = new Date(checkIn);
            minCheckOut.setDate(minCheckOut.getDate() + 1);
            document.getElementById('checkOutDate').min = minCheckOut.toISOString().split('T')[0];
            updateSummary();
        });

        document.getElementById('checkOutDate')?.addEventListener('change', updateSummary);
        document.getElementById('adultsCount')?.addEventListener('change', updateSummary);
        document.getElementById('childrenCount')?.addEventListener('change', updateSummary);

        // التنقل بين الخطوات
        function nextStep(step) {
            // التحقق من الخطوة الحالية
            if (currentStep === 1) {
                const checkIn = document.getElementById('checkInDate').value;
                const checkOut = document.getElementById('checkOutDate').value;
                if (!checkIn || !checkOut) {
                    alert('الرجاء اختيار تواريخ الإقامة');
                    return;
                }
                const nights = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
                if (nights <= 0) {
                    alert('تاريخ المغادرة يجب أن يكون بعد تاريخ الوصول');
                    return;
                }
            }
            
            if (currentStep === 2) {
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const email = document.getElementById('email').value;
                const phone = document.getElementById('phone').value;
                
                if (!firstName || !lastName || !email || !phone) {
                    alert('الرجاء ملء جميع البيانات المطلوبة');
                    return;
                }
                
                // التحقق من صحة البريد
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('الرجاء إدخال بريد إلكتروني صحيح');
                    return;
                }
            }

            // تحديث المؤشرات
            document.getElementById(`step${currentStep}-indicator`).classList.remove('active');
            document.getElementById(`step${currentStep}-indicator`).classList.add('completed');
            document.getElementById(`step${step}-indicator`).classList.add('active');

            // إخفاء الخطوة الحالية وإظهار التالية
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');

            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep(step) {
            document.getElementById(`step${currentStep}-indicator`).classList.remove('active');
            document.getElementById(`step${step}-indicator`).classList.remove('completed');
            document.getElementById(`step${step}-indicator`).classList.add('active');

            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');

            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // اختيار طريقة الدفع
        function selectPayment(element, method) {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input').checked = true;

            const cardDetails = document.getElementById('cardDetails');
            if (method === 'credit_card') {
                cardDetails.style.display = 'block';
            } else {
                cardDetails.style.display = 'none';
            }
        }

        // التهيئة
        updateSummary();
        
        // تعيين الحد الأدنى لتاريخ الوصول (اليوم)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checkInDate').min = today;
    </script>
</body>
</html>